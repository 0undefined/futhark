-- Source code:

-- -- Matrix-vector multiplication
-- def main [n] (xss: [n][n]i32) (v: [n]i32) : [n]i32 =
--     let vs = replicate n v
--     in map2 (\A_row vs_col ->
--         foldl (+) 0 (map2 (*) A_row vs_col)
--     ) xss vs

-- IR:

types {

}



entry("main",
      {xss: [][]i32,
       v: []i32},
      {[]i32})
  entry_main (n_5512 : i64,
              xss_5513 : [n_5512][n_5512]i32,
              v_5514 : [n_5512]i32)
  : {[n_5512]i32#([1, 2], [0])} = {
  let {nest_size_5723 : i64} =
    mul_nw64(n_5512, n_5512)
  let {segmap_group_size_5724 : i64} =
    get_size(segmap_group_size_5698, group_size)
  let {segmap_usable_groups_5725 : i64} =
    sdiv_up64(nest_size_5723, segmap_group_size_5724)
  let {defunc_0_map_res_r_5726 : [n_5512][n_5512]i32} =
    segmap(thread; ; groups=segmap_usable_groups_5725; groupsize=segmap_group_size_5724)
    (gtid_5727 < n_5512, gtid_5728 < n_5512) (~phys_tid_5729) : {i32} {
      let {eta_p_5730 : i32} =
        xss_5513[gtid_5727, gtid_5728]
      let {eta_p_5731 : i32} =
        v_5514[gtid_5728]
      let {defunc_0_f_res_5732 : i32} =
        mul32(eta_p_5730, eta_p_5731)
      return {returns defunc_0_f_res_5732}
    }
  let {segmap_group_size_5735 : i64} =
    get_size(segmap_group_size_5674, group_size)
  let {segmap_usable_groups_5736 : i64} =
    sdiv_up64(n_5512, segmap_group_size_5735)
  let {defunc_0_map_res_5737 : [n_5512]i32} =
    segmap(thread; ; groups=segmap_usable_groups_5736; groupsize=segmap_group_size_5735)
    (gtid_5738 < n_5512) (~phys_tid_5739) : {i32} {
      let {defunc_0_foldl_res_5741 : i32} =
        loop {acc_5743 : i32} = {0i32}
        for i_5742:i64 < n_5512 do {
          let {b_5744 : i32} =
            defunc_0_map_res_r_5726[gtid_5738, i_5742]
          let {defunc_0_f_res_5745 : i32} =
            add32(acc_5743, b_5744)
          in {defunc_0_f_res_5745}
        }
      return {returns defunc_0_foldl_res_5741}
    }
  in {defunc_0_map_res_5737}
}

-- === Expected output of analysis:
-- (segmap) defunc_0_map_res_r_5726 : {
--     (arr) xss_5513 : [0, 1] {
--         (idx) eta_p_5730 :
--             0 : dependencies = {gtid_5727 0 tid}
--             1 : dependencies = {gtid_5728 1 tid}
--     }
-- }
-- (segmap) defunc_0_map_res_5737 : {
--     (arr) defunc_0_map_res_r_5726 : [0, 1] {
--         (idx) b_5744 :
--             0 : dependencies = {gtid_5738 1 tid}
--             1 : dependencies = {i_5742 2 iter}
--     }
-- }
